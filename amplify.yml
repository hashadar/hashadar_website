version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Setup SSH for private repo access
        - mkdir -p ~/.ssh
        - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
        - chmod 600 ~/.ssh/id_rsa
        - ssh-keyscan github.com >> ~/.ssh/known_hosts
        
        # Clone blog repository (use default branch if BLOG_REPO_BRANCH not set)
        - |
          if [ -d "temp-blog-repo" ]; then
            cd temp-blog-repo
            git fetch origin
            if [ -n "$BLOG_REPO_BRANCH" ]; then
              git checkout -B $BLOG_REPO_BRANCH origin/$BLOG_REPO_BRANCH || git pull origin $BLOG_REPO_BRANCH
            else
              git pull
            fi
            cd ..
          else
            if [ -n "$BLOG_REPO_BRANCH" ]; then
              git clone --depth 1 -b $BLOG_REPO_BRANCH $BLOG_REPO_URL temp-blog-repo
            else
              git clone --depth 1 $BLOG_REPO_URL temp-blog-repo
            fi
          fi
        
        # Run blog sync script
        - node scripts/sync-blogs.js
        
        # Install dependencies
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - temp-blog-repo/**/*

